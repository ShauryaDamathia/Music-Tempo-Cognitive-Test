<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flanker Task</title>
  <style>
    body {
      background-color: black;
      color: yellow;
      font-family: Arial, sans-serif;
      font-size: 24px;
      text-align: center;
      margin-top: 150px;
    }
    .stimulus {
      font-size: 48px;
      margin-bottom: 50px;
    }
    .fixation {
      font-size: 48px;
      margin-top: 100px;
    }
  </style>
</head>
<body>

<div id="main">
  <div id="stimulus" class="stimulus"></div>
  <div id="fixation" class="fixation">+</div>
</div>

<script>
const congruentStimuli = ['CCCCC', 'VVVVV', 'XXXXX', 'BBBBB'];
const incongruentStimuli = [
  'CCXCC','CCBCC', 'CCVCC',
  'XXCXX', 'XXVXX','XXBXX',
  'VVBVV', 'VVCVV', 'VVXVV',
  'BBVBB', 'BBCBB', 'BBXBB'
];

const allStimuli = [...congruentStimuli, ...incongruentStimuli];
const trials = [];
const totalTrials = 10;

for (let i = 0; i < totalTrials; i++) {
  const stim = allStimuli[Math.floor(Math.random() * allStimuli.length)];
  trials.push(stim);
}

let currentTrial = 0;
let waitingForResponse = false;
let stimulusStart = 0;
let responseTimeout;

const fixation = document.getElementById("fixation");
const stimulusDiv = document.getElementById("stimulus");

const keyMapping = {
  'X': 'a',
  'C': 'a',
  'V': 'l',
  'B': 'l'
};

function showStimulus() {
  const stim = trials[currentTrial];
  stimulusDiv.textContent = stim;
  fixation.textContent = '';
  stimulusStart = performance.now();
  waitingForResponse = true;

  responseTimeout = setTimeout(() => {
    if (waitingForResponse) {
      recordResponse(null); 
    }
  }, 3000);
}

function showFixation(color = "white") {
  stimulusDiv.textContent = "";
  fixation.style.color = color;
  fixation.textContent = "+";
}

function showThankYouMessage() {
  document.body.innerHTML = '<h2 style="color: yellow; text-align: center; margin-top: 200px;">Thank you, Please wait...</h2>';
  setTimeout(() => {
    window.location.href = "{{ url_for('first') }}"; 
  }, 2000);
}

function recordResponse(pressedKey) {
  clearTimeout(responseTimeout);
  const stim = trials[currentTrial];
  const centralLetter = stim[2];
  const expectedKey = keyMapping[centralLetter.toUpperCase()];
  const isCorrect = (pressedKey === expectedKey);

  showFixation(pressedKey ? (isCorrect ? "green" : "red") : "red");

  waitingForResponse = false;
  currentTrial++;

  setTimeout(() => {
    nextTrial();
  }, 500);
}

function nextTrial() {
  if (currentTrial >= totalTrials) {
    showThankYouMessage();
    return;
  }
  showStimulus();
}

document.addEventListener("keydown", (e) => {
  if (!waitingForResponse) return;
  const key = e.key.toLowerCase();
  recordResponse(key);
});

setTimeout(() => {
  showStimulus();
}, 1000);
</script>

</body>
</html>
